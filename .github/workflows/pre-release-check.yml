name: Pre-Release Postmortem Check

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      base_ref:
        description: 'åŸºå‡†åˆ†æ”¯/tagï¼ˆç”¨äºŽå¯¹æ¯”ï¼‰'
        required: true
        default: 'main'
  # åˆ›å»º Release æ—¶è§¦å‘
  release:
    types: [created]
  # PR åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [main]

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  check-postmortems:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²

      - name: Get commits since last release
        id: get-commits
        run: |
          # èŽ·å–æœ€æ–°çš„ tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            echo "No previous tag found, checking all commits"
            COMMITS=$(git log --oneline HEAD)
          else
            echo "Comparing with tag: $LATEST_TAG"
            COMMITS=$(git log --oneline $LATEST_TAG..HEAD)
          fi

          # ä¿å­˜åˆ°æ–‡ä»¶
          echo "$COMMITS" > /tmp/commits.txt
          echo "commits_file=/tmp/commits.txt" >> $GITHUB_OUTPUT

      - name: Load existing postmortems
        id: load-postmortems
        run: |
          # åˆå¹¶æ‰€æœ‰ postmortem çš„æ£€æµ‹è§„åˆ™
          POSTMORTEMS=""
          for file in postmortem/PM-*.md; do
            if [ -f "$file" ]; then
              POSTMORTEMS="$POSTMORTEMS\n\n---\n\n$(cat "$file")"
            fi
          done

          echo "$POSTMORTEMS" > /tmp/postmortems.txt
          echo "postmortems_file=/tmp/postmortems.txt" >> $GITHUB_OUTPUT

      - name: Run static checks
        id: static-checks
        run: |
          echo "Running static postmortem checks..."

          ISSUES=""

          # PM-2026-001: æ£€æµ‹ cwd è¯¯ç”¨
          if grep -r "\.cwd" prompt-logger-skill-package/hooks/*.sh 2>/dev/null | grep -v "CLAUDE_PROJECT_DIR" | grep -v "^#"; then
            ISSUES="$ISSUES\n- PM-2026-001: å‘çŽ°å¯èƒ½é”™è¯¯ä½¿ç”¨ .cwd è€Œéž CLAUDE_PROJECT_DIR"
          fi

          if [ -n "$ISSUES" ]; then
            echo "issues_found=true" >> $GITHUB_OUTPUT
            echo -e "$ISSUES" > /tmp/issues.txt
          else
            echo "issues_found=false" >> $GITHUB_OUTPUT
          fi

      - name: AI Analysis (if API key available)
        if: env.ANTHROPIC_API_KEY != ''
        id: ai-analysis
        run: |
          echo "Running AI analysis..."

          COMMITS=$(cat /tmp/commits.txt)
          POSTMORTEMS=$(cat /tmp/postmortems.txt 2>/dev/null || echo "No existing postmortems")

          # è°ƒç”¨ Claude API è¿›è¡Œåˆ†æž
          PROMPT="ä½ æ˜¯ä¸€ä¸ªä»£ç å®¡æŸ¥ä¸“å®¶ã€‚è¯·åˆ†æžä»¥ä¸‹ commits æ˜¯å¦å¯èƒ½è§¦å‘å·²çŸ¥çš„ postmortem ä¸­æè¿°çš„é—®é¢˜ã€‚

## å¾…æ£€æŸ¥çš„ Commits:
$COMMITS

## å·²çŸ¥çš„ Postmortems:
$POSTMORTEMS

è¯·æ£€æŸ¥ï¼š
1. è¿™äº› commits æ˜¯å¦å¼•å…¥äº†ä¸Žå·²çŸ¥ postmortem ç±»ä¼¼çš„é—®é¢˜æ¨¡å¼
2. æ˜¯å¦æœ‰æ½œåœ¨çš„é£Žé™©ç‚¹
3. å»ºè®®çš„æ”¹è¿›æŽªæ–½

å¦‚æžœå‘çŽ°é—®é¢˜ï¼Œè¯·è¾“å‡º 'RISK_FOUND: ' å¼€å¤´çš„è­¦å‘Šä¿¡æ¯ã€‚
å¦‚æžœæ²¡æœ‰é—®é¢˜ï¼Œè¯·è¾“å‡º 'NO_RISK: ' å¼€å¤´çš„ç¡®è®¤ä¿¡æ¯ã€‚"

          # ä½¿ç”¨ curl è°ƒç”¨ Claude API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 2048,
              \"messages\": [{\"role\": \"user\", \"content\": $(echo "$PROMPT" | jq -Rs .)}]
            }" | jq -r '.content[0].text // "API call failed"')

          echo "$RESPONSE" > /tmp/ai_analysis.txt

          if echo "$RESPONSE" | grep -q "RISK_FOUND:"; then
            echo "risk_found=true" >> $GITHUB_OUTPUT
          else
            echo "risk_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Report results
        run: |
          echo "## Pre-Release Postmortem Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # é™æ€æ£€æŸ¥ç»“æžœ
          if [ "${{ steps.static-checks.outputs.issues_found }}" == "true" ]; then
            echo "### âš ï¸ Static Check Issues Found" >> $GITHUB_STEP_SUMMARY
            cat /tmp/issues.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Static Checks Passed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # AI åˆ†æžç»“æžœ
          if [ -f /tmp/ai_analysis.txt ]; then
            echo "### ðŸ¤– AI Analysis" >> $GITHUB_STEP_SUMMARY
            cat /tmp/ai_analysis.txt >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if issues found
        if: steps.static-checks.outputs.issues_found == 'true' || steps.ai-analysis.outputs.risk_found == 'true'
        run: |
          echo "::error::Pre-release check failed. Please review the postmortem issues above."
          exit 1
