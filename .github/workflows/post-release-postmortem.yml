name: Post-Release Postmortem Generator

on:
  # Release å‘å¸ƒåŽè§¦å‘
  release:
    types: [published]
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to analyze'
        required: true

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  generate-postmortem:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get release info
        id: release-info
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            RELEASE_TAG="${{ github.event.inputs.release_tag }}"
          else
            RELEASE_TAG="${{ github.event.release.tag_name }}"
          fi

          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT

          # èŽ·å–ä¸Šä¸€ä¸ª tag
          PREV_TAG=$(git describe --tags --abbrev=0 $RELEASE_TAG^ 2>/dev/null || echo "")
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Get fix commits in this release
        id: get-fixes
        run: |
          RELEASE_TAG="${{ steps.release-info.outputs.release_tag }}"
          PREV_TAG="${{ steps.release-info.outputs.prev_tag }}"

          if [ -z "$PREV_TAG" ]; then
            FIX_COMMITS=$(git log --oneline $RELEASE_TAG | grep -i "fix" || echo "")
          else
            FIX_COMMITS=$(git log --oneline $PREV_TAG..$RELEASE_TAG | grep -i "fix" || echo "")
          fi

          if [ -z "$FIX_COMMITS" ]; then
            echo "No fix commits found in this release"
            echo "has_fixes=false" >> $GITHUB_OUTPUT
          else
            echo "$FIX_COMMITS" > /tmp/fix_commits.txt
            echo "has_fixes=true" >> $GITHUB_OUTPUT

            # èŽ·å–æ¯ä¸ª fix commit çš„è¯¦ç»†ä¿¡æ¯
            echo "" > /tmp/fix_details.txt
            echo "$FIX_COMMITS" | while read line; do
              HASH=$(echo "$line" | cut -d' ' -f1)
              git show $HASH --stat >> /tmp/fix_details.txt
              echo "---" >> /tmp/fix_details.txt
            done
          fi

      - name: Load existing postmortems
        if: steps.get-fixes.outputs.has_fixes == 'true'
        run: |
          # èŽ·å–çŽ°æœ‰ postmortem çš„æœ€å¤§ç¼–å·
          MAX_NUM=$(ls postmortem/PM-*.md 2>/dev/null | sed 's/.*PM-[0-9]*-\([0-9]*\).*/\1/' | sort -n | tail -1 || echo "0")
          NEXT_NUM=$(printf "%03d" $((10#$MAX_NUM + 1)))
          YEAR=$(date +%Y)

          echo "NEXT_PM_ID=PM-$YEAR-$NEXT_NUM" >> $GITHUB_ENV

          # æ”¶é›†çŽ°æœ‰ postmortems
          cat postmortem/PM-*.md 2>/dev/null > /tmp/existing_postmortems.txt || echo "" > /tmp/existing_postmortems.txt

      - name: Generate postmortem with AI
        if: steps.get-fixes.outputs.has_fixes == 'true' && env.ANTHROPIC_API_KEY != ''
        id: generate-pm
        run: |
          FIX_COMMITS=$(cat /tmp/fix_commits.txt)
          FIX_DETAILS=$(cat /tmp/fix_details.txt)
          EXISTING_PMS=$(cat /tmp/existing_postmortems.txt)
          TEMPLATE=$(cat postmortem/TEMPLATE.md)

          PROMPT="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è½¯ä»¶å·¥ç¨‹å¸ˆï¼Œè´Ÿè´£æ’°å†™ Postmortemï¼ˆå°¸æ£€æŠ¥å‘Šï¼‰ã€‚

è¯·æ ¹æ®ä»¥ä¸‹ fix commits ç”Ÿæˆä¸€ä»½ä¸“ä¸šçš„ Postmortem æŠ¥å‘Šã€‚

## Fix Commits åˆ—è¡¨:
$FIX_COMMITS

## Fix Commits è¯¦æƒ…:
$FIX_DETAILS

## çŽ°æœ‰çš„ Postmortemsï¼ˆä¾›å‚è€ƒï¼Œé¿å…é‡å¤ï¼‰:
$EXISTING_PMS

## Postmortem æ¨¡æ¿:
$TEMPLATE

è¯·ç”Ÿæˆä¸€ä»½å®Œæ•´çš„ Postmortem æŠ¥å‘Šï¼Œæ ¼å¼éµå¾ªæ¨¡æ¿ã€‚
- ID ä½¿ç”¨: $NEXT_PM_ID
- å¦‚æžœå¤šä¸ª fix ç›¸å…³ï¼Œå¯ä»¥åˆå¹¶æˆä¸€ä¸ª postmortem
- å¦‚æžœ fix ä¸ŽçŽ°æœ‰ postmortem é‡å¤æˆ–ç›¸å…³ï¼Œè¯·æ³¨æ˜Ž
- ç¡®ä¿åŒ…å«æ£€æµ‹è§„åˆ™ï¼Œä¾¿äºŽ CI è‡ªåŠ¨æ£€æŸ¥
- ä½¿ç”¨ä¸­æ–‡æ’°å†™

åªè¾“å‡º Markdown æ ¼å¼çš„ Postmortem å†…å®¹ï¼Œä¸è¦æœ‰å…¶ä»–è¯´æ˜Žã€‚"

          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 4096,
              \"messages\": [{\"role\": \"user\", \"content\": $(echo "$PROMPT" | jq -Rs .)}]
            }" | jq -r '.content[0].text // ""')

          if [ -n "$RESPONSE" ] && [ "$RESPONSE" != "null" ]; then
            # ç”Ÿæˆæ–‡ä»¶å
            TITLE=$(echo "$RESPONSE" | grep -m1 "^# " | sed 's/^# //' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | cut -c1-50)
            FILENAME="${NEXT_PM_ID}-${TITLE}.md"

            echo "$RESPONSE" > "postmortem/$FILENAME"
            echo "generated_file=postmortem/$FILENAME" >> $GITHUB_OUTPUT
            echo "generated=true" >> $GITHUB_OUTPUT
          else
            echo "generated=false" >> $GITHUB_OUTPUT
          fi

      - name: Update postmortem index
        if: steps.generate-pm.outputs.generated == 'true'
        run: |
          # æ›´æ–° README.md ä¸­çš„ç´¢å¼•è¡¨æ ¼
          NEW_FILE="${{ steps.generate-pm.outputs.generated_file }}"
          FILENAME=$(basename "$NEW_FILE")

          # æå–æ ‡é¢˜ï¼ˆä»Žç”Ÿæˆçš„æ–‡ä»¶ï¼‰
          TITLE=$(grep -m1 "^# " "$NEW_FILE" | sed 's/^# //' | head -c 60)
          SEVERITY=$(grep -m1 "ä¸¥é‡çº§åˆ«" "$NEW_FILE" | sed 's/.*| *\(.*\) *|$/\1/' | xargs)

          # åœ¨ README çš„ç´¢å¼•è¡¨æ ¼ä¸­æ·»åŠ æ–°æ¡ç›®
          sed -i "/^| \[PM-/a | [$NEXT_PM_ID](./$FILENAME) | $TITLE | $SEVERITY | å·²ä¿®å¤ |" postmortem/README.md

      - name: Create Pull Request
        if: steps.generate-pm.outputs.generated == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: æ·»åŠ  ${{ env.NEXT_PM_ID }} Postmortem æŠ¥å‘Š"
          title: "ðŸ“‹ Postmortem: ${{ env.NEXT_PM_ID }}"
          body: |
            ## è‡ªåŠ¨ç”Ÿæˆçš„ Postmortem æŠ¥å‘Š

            æœ¬ PR ç”± Post-Release Postmortem Generator è‡ªåŠ¨åˆ›å»ºã€‚

            ### Release ä¿¡æ¯
            - Tag: ${{ steps.release-info.outputs.release_tag }}
            - ä¸Šä¸€ä¸ª Tag: ${{ steps.release-info.outputs.prev_tag }}

            ### ç”Ÿæˆçš„æ–‡ä»¶
            - ${{ steps.generate-pm.outputs.generated_file }}

            ### æ£€æŸ¥æ¸…å•
            - [ ] ç¡®è®¤ Postmortem å†…å®¹å‡†ç¡®
            - [ ] ç¡®è®¤æ£€æµ‹è§„åˆ™å¯ç”¨
            - [ ] ç¡®è®¤æ²¡æœ‰æ•æ„Ÿä¿¡æ¯

            ---
            ðŸ¤– è‡ªåŠ¨ç”Ÿæˆ by GitHub Actions
          branch: postmortem/${{ env.NEXT_PM_ID }}
          delete-branch: true

      - name: Summary
        run: |
          echo "## Post-Release Postmortem Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** ${{ steps.release-info.outputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.get-fixes.outputs.has_fixes }}" == "true" ]; then
            echo "### Fix Commits Found:" >> $GITHUB_STEP_SUMMARY
            cat /tmp/fix_commits.txt >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "${{ steps.generate-pm.outputs.generated }}" == "true" ]; then
              echo "### âœ… Postmortem Generated" >> $GITHUB_STEP_SUMMARY
              echo "File: ${{ steps.generate-pm.outputs.generated_file }}" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âš ï¸ Postmortem Generation Failed" >> $GITHUB_STEP_SUMMARY
              echo "Please check the AI API configuration." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âœ… No Fix Commits" >> $GITHUB_STEP_SUMMARY
            echo "No fix commits found in this release. No postmortem needed." >> $GITHUB_STEP_SUMMARY
          fi
